name: Nightly SDK Compatibility Check

on:
  schedule:
    - cron: '0 6 * * *' # 6am UTC daily
  workflow_dispatch:

jobs:
  check-sdks:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install current dependencies
        run: npm install

      - name: Bump SDKs to latest
        run: |
          npm install \
            @anthropic-ai/claude-agent-sdk@latest \
            @github/copilot-sdk@latest \
            @openai/codex-sdk@latest \
            @codewithdan/agent-sdk-core@latest \
            -w server

          npm install \
            @anthropic-ai/claude-agent-sdk@latest \
            @github/copilot-sdk@latest \
            @openai/codex-sdk@latest \
            @codewithdan/agent-sdk-core@latest

      - name: Show updated versions
        run: |
          echo "### SDK Versions" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          npm ls @anthropic-ai/claude-agent-sdk @github/copilot-sdk @openai/codex-sdk @codewithdan/agent-sdk-core 2>&1 | grep -E '@anthropic|@github/copilot|@openai/codex|agent-sdk-core' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Build server
        run: npm run build:server

      - name: Build client
        run: npm run build:client

      - name: Typecheck server
        run: npm run typecheck -w server

      - name: Run client tests
        run: npm run test

      - name: Open issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = `Nightly SDK check failed (${new Date().toISOString().split('T')[0]})`;
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'sdk-compatibility',
              per_page: 1,
            });
            if (issues.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                labels: ['sdk-compatibility'],
                body: `The nightly SDK compatibility check failed.\n\n[View run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`,
              });
            }
